<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>OpenVPN: src/openvpn/auth_token.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">OpenVPN
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_92f13d409beef24f5ba1b81abfed1f1c.html">openvpn</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">auth_token.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &quot;<a class="el" href="syshead_8h_source.html">syshead.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="base64_8h_source.html">base64.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="buffer_8h_source.html">buffer.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="crypto_8h_source.html">crypto.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="openvpn_8h_source.html">openvpn.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="ssl__common_8h_source.html">ssl_common.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="auth__token_8h_source.html">auth_token.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="push_8h_source.html">push.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="integer_8h_source.html">integer.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="ssl_8h_source.html">ssl.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="ssl__verify_8h_source.html">ssl_verify.h</a>&quot;</code><br />
<code>#include &lt;inttypes.h&gt;</code><br />
</div><div class="textblock"><div class="dynheader">
Include dependency graph for auth_token.c:</div>
<div class="dyncontent">
<div class="center"><img src="auth__token_8c__incl.png" border="0" usemap="#src_2openvpn_2auth__token_8c" alt=""/></div>
<map name="src_2openvpn_2auth__token_8c" id="src_2openvpn_2auth__token_8c">
<area shape="rect" title=" " alt="" coords="2765,5,2937,32"/>
<area shape="rect" href="syshead_8h.html" title=" " alt="" coords="593,379,675,405"/>
<area shape="rect" href="base64_8h.html" title=" " alt="" coords="3237,80,3311,107"/>
<area shape="rect" href="buffer_8h.html" title=" " alt="" coords="2276,827,2341,853"/>
<area shape="rect" href="crypto_8h.html" title=" " alt="" coords="2854,453,2923,480"/>
<area shape="rect" href="openvpn_8h.html" title=" " alt="" coords="1921,229,2003,256"/>
<area shape="rect" href="integer_8h.html" title=" " alt="" coords="1383,827,1455,853"/>
<area shape="rect" href="ssl_8h.html" title=" " alt="" coords="2863,304,2914,331"/>
<area shape="rect" href="ssl__common_8h.html" title=" " alt="" coords="2581,379,2687,405"/>
<area shape="rect" href="auth__token_8h.html" title=" " alt="" coords="3336,80,3433,107"/>
<area shape="rect" href="push_8h.html" title=" " alt="" coords="2315,80,2377,107"/>
<area shape="rect" href="ssl__verify_8h.html" title=" " alt="" coords="1113,304,1201,331"/>
<area shape="rect" title=" " alt="" coords="3457,80,3536,107"/>
<area shape="rect" href="compat_8h.html" title=" " alt="" coords="5,453,81,480"/>
<area shape="rect" title=" " alt="" coords="983,976,1058,1003"/>
<area shape="rect" title=" " alt="" coords="157,453,241,480"/>
<area shape="rect" title=" " alt="" coords="266,453,354,480"/>
<area shape="rect" title=" " alt="" coords="379,453,457,480"/>
<area shape="rect" title=" " alt="" coords="481,453,568,480"/>
<area shape="rect" title=" " alt="" coords="593,453,675,480"/>
<area shape="rect" title=" " alt="" coords="699,453,777,480"/>
<area shape="rect" title=" " alt="" coords="801,453,875,480"/>
<area shape="rect" title=" " alt="" coords="899,453,977,480"/>
<area shape="rect" title=" " alt="" coords="1001,453,1086,480"/>
<area shape="rect" href="openvpn_2basic_8h.html" title=" " alt="" coords="2217,976,2281,1003"/>
<area shape="rect" href="openvpn_2error_8h.html" title=" " alt="" coords="1893,901,1951,928"/>
<area shape="rect" href="crypto__backend_8h.html" title=" " alt="" coords="2765,752,2890,779"/>
<area shape="rect" href="packet__id_8h.html" title=" " alt="" coords="2717,528,2807,555"/>
<area shape="rect" href="mtu_8h.html" title=" " alt="" coords="2423,677,2477,704"/>
<area shape="rect" href="options_8h.html" title=" " alt="" coords="2273,453,2347,480"/>
<area shape="rect" href="route_8h.html" title=" " alt="" coords="1891,528,1953,555"/>
<area shape="rect" href="tun_8h.html" title=" " alt="" coords="2018,603,2069,629"/>
<area shape="rect" href="misc_8h.html" title=" " alt="" coords="1849,752,1910,779"/>
<area shape="rect" href="socket_8h.html" title=" " alt="" coords="2298,603,2370,629"/>
<area shape="rect" href="proxy_8h.html" title=" " alt="" coords="2182,677,2246,704"/>
<area shape="rect" href="socks_8h.html" title=" " alt="" coords="1684,677,1752,704"/>
<area shape="rect" href="plugin_8h.html" title=" " alt="" coords="2525,528,2591,555"/>
<area shape="rect" href="manage_8h.html" title=" " alt="" coords="1788,528,1867,555"/>
<area shape="rect" href="comp_8h.html" title=" " alt="" coords="2131,528,2196,555"/>
<area shape="rect" href="interval_8h.html" title=" " alt="" coords="1234,752,1309,779"/>
<area shape="rect" href="status_8h.html" title=" " alt="" coords="1222,379,1291,405"/>
<area shape="rect" href="fragment_8h.html" title=" " alt="" coords="1467,603,1551,629"/>
<area shape="rect" href="shaper_8h.html" title=" " alt="" coords="1385,677,1457,704"/>
<area shape="rect" href="sig_8h.html" title=" " alt="" coords="1275,304,1326,331"/>
<area shape="rect" href="mbuf_8h.html" title=" " alt="" coords="2157,752,2220,779"/>
<area shape="rect" href="pf_8h.html" title=" " alt="" coords="2232,304,2276,331"/>
<area shape="rect" href="pool_8h.html" title=" " alt="" coords="1351,304,1408,331"/>
<area shape="rect" href="session__id_8h.html" title=" " alt="" coords="3117,603,3212,629"/>
<area shape="rect" href="ssl__backend_8h.html" title=" " alt="" coords="3005,453,3111,480"/>
<area shape="rect" href="forward_8h.html" title=" " alt="" coords="2125,155,2201,181"/>
</map>
</div>
</div><div class="textblock"><div class="dynheader">
This graph shows which files directly or indirectly include this file:</div>
<div class="dyncontent">
<div class="center"><img src="auth__token_8c__dep__incl.png" border="0" usemap="#src_2openvpn_2auth__token_8cdep" alt=""/></div>
<map name="src_2openvpn_2auth__token_8cdep" id="src_2openvpn_2auth__token_8cdep">
<area shape="rect" title=" " alt="" coords="5,5,177,32"/>
<area shape="rect" href="test__auth__token_8c.html" title=" " alt="" coords="9,80,174,121"/>
</map>
</div>
</div>
<p><a href="auth__token_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:a753fd5159bdd46f5f45ea815b01dfe4a"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="auth__token_8c.html#a753fd5159bdd46f5f45ea815b01dfe4a">AUTH_TOKEN_SESSION_ID_LEN</a>&#160;&#160;&#160;12</td></tr>
<tr class="separator:a753fd5159bdd46f5f45ea815b01dfe4a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abad417630692ef5a666077b0795f4913"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="auth__token_8c.html#abad417630692ef5a666077b0795f4913">TOKEN_DATA_LEN</a>&#160;&#160;&#160;(2 * sizeof(<a class="el" href="config-msvc_8h.html#a67a9885ef4908cb72ce26d75b694386c">int64_t</a>) + <a class="el" href="auth__token_8c.html#a753fd5159bdd46f5f45ea815b01dfe4a">AUTH_TOKEN_SESSION_ID_LEN</a> + 32)</td></tr>
<tr class="separator:abad417630692ef5a666077b0795f4913"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a9c21b265d0852c0811ef0879d1a4b100"><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structkey__type.html">key_type</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="auth__token_8c.html#a9c21b265d0852c0811ef0879d1a4b100">auth_token_kt</a> (void)</td></tr>
<tr class="separator:a9c21b265d0852c0811ef0879d1a4b100"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9d5d7fb657e7391aa5d1565d4aa09ca7"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="auth__token_8c.html#a9d5d7fb657e7391aa5d1565d4aa09ca7">add_session_token_env</a> (struct <a class="el" href="structtls__session.html">tls_session</a> *<a class="el" href="structsession.html">session</a>, struct <a class="el" href="structtls__multi.html">tls_multi</a> *multi, const struct <a class="el" href="structuser__pass.html">user_pass</a> *up)</td></tr>
<tr class="memdesc:a9d5d7fb657e7391aa5d1565d4aa09ca7"><td class="mdescLeft">&#160;</td><td class="mdescRight">Put the session id, and auth token status into the environment if auth-token is enabled.  <a href="auth__token_8c.html#a9d5d7fb657e7391aa5d1565d4aa09ca7">More...</a><br /></td></tr>
<tr class="separator:a9d5d7fb657e7391aa5d1565d4aa09ca7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3c1f33bc014ff76d54a50720ef0f8711"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="auth__token_8c.html#a3c1f33bc014ff76d54a50720ef0f8711">auth_token_write_server_key_file</a> (const char *filename)</td></tr>
<tr class="memdesc:a3c1f33bc014ff76d54a50720ef0f8711"><td class="mdescLeft">&#160;</td><td class="mdescRight">Generate a auth-token server secret key, and write to file.  <a href="auth__token_8c.html#a3c1f33bc014ff76d54a50720ef0f8711">More...</a><br /></td></tr>
<tr class="separator:a3c1f33bc014ff76d54a50720ef0f8711"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4a2164f546ead4f4a07e18b4d15954c2"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="auth__token_8c.html#a4a2164f546ead4f4a07e18b4d15954c2">auth_token_init_secret</a> (struct <a class="el" href="structkey__ctx.html">key_ctx</a> *<a class="el" href="structkey__ctx.html">key_ctx</a>, const char *key_file, bool key_inline)</td></tr>
<tr class="memdesc:a4a2164f546ead4f4a07e18b4d15954c2"><td class="mdescLeft">&#160;</td><td class="mdescRight">Loads an HMAC secret from a file or if no file is present generates a epheremal secret for the run time of the server and stores it into ctx.  <a href="auth__token_8c.html#a4a2164f546ead4f4a07e18b4d15954c2">More...</a><br /></td></tr>
<tr class="separator:a4a2164f546ead4f4a07e18b4d15954c2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a65b16bc3800ad5970a63cbbe13c1b9d4"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="auth__token_8c.html#a65b16bc3800ad5970a63cbbe13c1b9d4">generate_auth_token</a> (const struct <a class="el" href="structuser__pass.html">user_pass</a> *up, struct <a class="el" href="structtls__multi.html">tls_multi</a> *multi)</td></tr>
<tr class="memdesc:a65b16bc3800ad5970a63cbbe13c1b9d4"><td class="mdescLeft">&#160;</td><td class="mdescRight">Generate an auth token based on username and timestamp.  <a href="auth__token_8c.html#a65b16bc3800ad5970a63cbbe13c1b9d4">More...</a><br /></td></tr>
<tr class="separator:a65b16bc3800ad5970a63cbbe13c1b9d4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4a041f0d8d54bc6adee83d61e7eec624"><td class="memItemLeft" align="right" valign="top">static bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="auth__token_8c.html#a4a041f0d8d54bc6adee83d61e7eec624">check_hmac_token</a> (<a class="el" href="crypto__mbedtls_8h.html#a673f50867e637575e463123b9a6b8180">hmac_ctx_t</a> *ctx, const <a class="el" href="config-msvc_8h.html#a9a941819355e6f658991890ff66b4b0e">uint8_t</a> *b64decoded, const char *username)</td></tr>
<tr class="separator:a4a041f0d8d54bc6adee83d61e7eec624"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8d927575260ef846146a4219a59384ab"><td class="memItemLeft" align="right" valign="top">unsigned int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="auth__token_8c.html#a8d927575260ef846146a4219a59384ab">verify_auth_token</a> (struct <a class="el" href="structuser__pass.html">user_pass</a> *up, struct <a class="el" href="structtls__multi.html">tls_multi</a> *multi, struct <a class="el" href="structtls__session.html">tls_session</a> *<a class="el" href="structsession.html">session</a>)</td></tr>
<tr class="memdesc:a8d927575260ef846146a4219a59384ab"><td class="mdescLeft">&#160;</td><td class="mdescRight">Verifies the auth token to be in the format that generate_auth_token create and checks if the token is valid.  <a href="auth__token_8c.html#a8d927575260ef846146a4219a59384ab">More...</a><br /></td></tr>
<tr class="separator:a8d927575260ef846146a4219a59384ab"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae2422a1db17af810579e69329ed68b7f"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="auth__token_8c.html#ae2422a1db17af810579e69329ed68b7f">wipe_auth_token</a> (struct <a class="el" href="structtls__multi.html">tls_multi</a> *multi)</td></tr>
<tr class="memdesc:ae2422a1db17af810579e69329ed68b7f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Wipes the authentication token out of the memory, frees and cleans up related buffers and flags.  <a href="auth__token_8c.html#ae2422a1db17af810579e69329ed68b7f">More...</a><br /></td></tr>
<tr class="separator:ae2422a1db17af810579e69329ed68b7f"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a9eadc45b0a43398b27fee777f6a6261d"><td class="memItemLeft" align="right" valign="top">const char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="auth__token_8c.html#a9eadc45b0a43398b27fee777f6a6261d">auth_token_pem_name</a> = &quot;OpenVPN auth-token server <a class="el" href="structkey.html">key</a>&quot;</td></tr>
<tr class="separator:a9eadc45b0a43398b27fee777f6a6261d"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Macro Definition Documentation</h2>
<a id="a753fd5159bdd46f5f45ea815b01dfe4a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a753fd5159bdd46f5f45ea815b01dfe4a">&#9670;&nbsp;</a></span>AUTH_TOKEN_SESSION_ID_LEN</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define AUTH_TOKEN_SESSION_ID_LEN&#160;&#160;&#160;12</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="auth__token_8c_source.html#l00023">23</a> of file <a class="el" href="auth__token_8c_source.html">auth_token.c</a>.</p>

</div>
</div>
<a id="abad417630692ef5a666077b0795f4913"></a>
<h2 class="memtitle"><span class="permalink"><a href="#abad417630692ef5a666077b0795f4913">&#9670;&nbsp;</a></span>TOKEN_DATA_LEN</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define TOKEN_DATA_LEN&#160;&#160;&#160;(2 * sizeof(<a class="el" href="config-msvc_8h.html#a67a9885ef4908cb72ce26d75b694386c">int64_t</a>) + <a class="el" href="auth__token_8c.html#a753fd5159bdd46f5f45ea815b01dfe4a">AUTH_TOKEN_SESSION_ID_LEN</a> + 32)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="auth__token_8c_source.html#l00029">29</a> of file <a class="el" href="auth__token_8c_source.html">auth_token.c</a>.</p>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="a9d5d7fb657e7391aa5d1565d4aa09ca7"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9d5d7fb657e7391aa5d1565d4aa09ca7">&#9670;&nbsp;</a></span>add_session_token_env()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void add_session_token_env </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structtls__session.html">tls_session</a> *&#160;</td>
          <td class="paramname"><em>session</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structtls__multi.html">tls_multi</a> *&#160;</td>
          <td class="paramname"><em>multi</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const struct <a class="el" href="structuser__pass.html">user_pass</a> *&#160;</td>
          <td class="paramname"><em>up</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Put the session id, and auth token status into the environment if auth-token is enabled. </p>

<p class="definition">Definition at line <a class="el" href="auth__token_8c_source.html#l00052">52</a> of file <a class="el" href="auth__token_8c_source.html">auth_token.c</a>.</p>

<p class="reference">References <a class="el" href="openvpn_2error_8h_source.html#l00218">ASSERT</a>, <a class="el" href="ssl__common_8h_source.html#l00567">tls_multi::auth_token</a>, <a class="el" href="ssl__common_8h_source.html#l00577">AUTH_TOKEN_EXPIRED</a>, <a class="el" href="ssl__common_8h_source.html#l00320">tls_options::auth_token_generate</a>, <a class="el" href="ssl__common_8h_source.html#l00575">AUTH_TOKEN_HMAC_OK</a>, <a class="el" href="auth__token_8c_source.html#l00023">AUTH_TOKEN_SESSION_ID_LEN</a>, <a class="el" href="ssl__common_8h_source.html#l00579">AUTH_TOKEN_VALID_EMPTYUSER</a>, <a class="el" href="auth__token_8c_source.html#l00176">generate_auth_token()</a>, <a class="el" href="auth__token_8h_source.html#l00127">is_auth_token()</a>, <a class="el" href="keyingmaterialexporter_8c_source.html#l00058">session::key</a>, <a class="el" href="ssl__common_8h_source.html#l00381">KS_PRIMARY</a>, <a class="el" href="ssl__common_8h_source.html#l00516">tls_multi::opt</a>, <a class="el" href="misc_8h_source.html#l00079">user_pass::password</a>, <a class="el" href="auth__token_8h_source.html#l00115">SESSION_ID_PREFIX</a>, and <a class="el" href="env__set_8c_source.html#l00285">setenv_str()</a>.</p>

<p class="reference">Referenced by <a class="el" href="test__auth__token_8c_source.html#l00304">auth_token_test_env()</a>, and <a class="el" href="ssl__verify_8c_source.html#l01244">set_verify_user_pass_env()</a>.</p>

</div>
</div>
<a id="a4a2164f546ead4f4a07e18b4d15954c2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4a2164f546ead4f4a07e18b4d15954c2">&#9670;&nbsp;</a></span>auth_token_init_secret()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void auth_token_init_secret </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structkey__ctx.html">key_ctx</a> *&#160;</td>
          <td class="paramname"><em>key_ctx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>key_file</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&#160;</td>
          <td class="paramname"><em>key_inline</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Loads an HMAC secret from a file or if no file is present generates a epheremal secret for the run time of the server and stores it into ctx. </p>

<p class="definition">Definition at line <a class="el" href="auth__token_8c_source.html#l00139">139</a> of file <a class="el" href="auth__token_8c_source.html">auth_token.c</a>.</p>

<p class="reference">References <a class="el" href="buffer_8c_source.html#l00064">alloc_buf()</a>, <a class="el" href="auth__token_8c_source.html#l00032">auth_token_kt()</a>, <a class="el" href="auth__token_8c_source.html#l00021">auth_token_pem_name</a>, <a class="el" href="buffer_8h_source.html#l00784">buf_read()</a>, <a class="el" href="buffer_8c_source.html#l00185">free_buf()</a>, <a class="el" href="crypto_8c_source.html#l01895">generate_ephemeral_key()</a>, <a class="el" href="crypto_8c_source.html#l00823">init_key_ctx()</a>, <a class="el" href="openvpn_2error_8h_source.html#l00091">M_FATAL</a>, <a class="el" href="openvpn_2error_8h_source.html#l00170">msg</a>, and <a class="el" href="crypto_8c_source.html#l01913">read_pem_key_file()</a>.</p>

<p class="reference">Referenced by <a class="el" href="test__auth__token_8c_source.html#l00362">auth_token_test_key_load()</a>, <a class="el" href="test__auth__token_8c_source.html#l00338">auth_token_test_random_keys()</a>, and <a class="el" href="init_8c_source.html#l02701">do_init_auth_token_key()</a>.</p>

</div>
</div>
<a id="a9c21b265d0852c0811ef0879d1a4b100"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9c21b265d0852c0811ef0879d1a4b100">&#9670;&nbsp;</a></span>auth_token_kt()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static struct <a class="el" href="structkey__type.html">key_type</a> auth_token_kt </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="auth__token_8c_source.html#l00032">32</a> of file <a class="el" href="auth__token_8c_source.html">auth_token.c</a>.</p>

<p class="reference">References <a class="el" href="crypto_8h_source.html#l00143">key_type::cipher</a>, <a class="el" href="crypto_8h_source.html#l00144">key_type::digest</a>, <a class="el" href="crypto_8h_source.html#l00142">key_type::hmac_length</a>, <a class="el" href="openvpn_2error_8h_source.html#l00093">M_WARN</a>, <a class="el" href="crypto__openssl_8c_source.html#l00952">md_kt_get()</a>, <a class="el" href="crypto__backend_8h.html#aaf03842b74cab3e4304e655aeaf75d2e">md_kt_size()</a>, and <a class="el" href="openvpn_2error_8h_source.html#l00170">msg</a>.</p>

<p class="reference">Referenced by <a class="el" href="auth__token_8c_source.html#l00139">auth_token_init_secret()</a>, and <a class="el" href="test__auth__token_8c_source.html#l00089">setup()</a>.</p>

</div>
</div>
<a id="a3c1f33bc014ff76d54a50720ef0f8711"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3c1f33bc014ff76d54a50720ef0f8711">&#9670;&nbsp;</a></span>auth_token_write_server_key_file()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void auth_token_write_server_key_file </td>
          <td>(</td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>filename</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Generate a auth-token server secret key, and write to file. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">filename</td><td>Filename of the server key file to create. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="auth__token_8c_source.html#l00133">133</a> of file <a class="el" href="auth__token_8c_source.html">auth_token.c</a>.</p>

<p class="reference">References <a class="el" href="auth__token_8c_source.html#l00021">auth_token_pem_name</a>, and <a class="el" href="crypto_8c_source.html#l01857">write_pem_key_file()</a>.</p>

<p class="reference">Referenced by <a class="el" href="init_8c_source.html#l01101">do_genkey()</a>.</p>

</div>
</div>
<a id="a4a041f0d8d54bc6adee83d61e7eec624"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4a041f0d8d54bc6adee83d61e7eec624">&#9670;&nbsp;</a></span>check_hmac_token()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static bool check_hmac_token </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="crypto__mbedtls_8h.html#a673f50867e637575e463123b9a6b8180">hmac_ctx_t</a> *&#160;</td>
          <td class="paramname"><em>ctx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="config-msvc_8h.html#a9a941819355e6f658991890ff66b4b0e">uint8_t</a> *&#160;</td>
          <td class="paramname"><em>b64decoded</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>username</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="auth__token_8c_source.html#l00286">286</a> of file <a class="el" href="auth__token_8c_source.html">auth_token.c</a>.</p>

<p class="reference">References <a class="el" href="openvpn_2error_8h_source.html#l00218">ASSERT</a>, <a class="el" href="crypto__backend_8h.html#a253c2c692da0d3706ca0f2ac5628a90e">hmac_ctx_final()</a>, <a class="el" href="crypto__backend_8h.html#a11227ed744de3ec49ba41ebe20aecb7b">hmac_ctx_reset()</a>, <a class="el" href="crypto__backend_8h.html#a8625131329a13b2097ccacb82c83b3fe">hmac_ctx_size()</a>, <a class="el" href="crypto__backend_8h.html#a0a5053c34da29530f5ec4dd8a7ed8009">hmac_ctx_update()</a>, <a class="el" href="crypto__openssl_8c_source.html#l01167">memcmp_constant_time()</a>, and <a class="el" href="auth__token_8c_source.html#l00029">TOKEN_DATA_LEN</a>.</p>

<p class="reference">Referenced by <a class="el" href="auth__token_8c_source.html#l00302">verify_auth_token()</a>.</p>

</div>
</div>
<a id="a65b16bc3800ad5970a63cbbe13c1b9d4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a65b16bc3800ad5970a63cbbe13c1b9d4">&#9670;&nbsp;</a></span>generate_auth_token()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void generate_auth_token </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structuser__pass.html">user_pass</a> *&#160;</td>
          <td class="paramname"><em>up</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structtls__multi.html">tls_multi</a> *&#160;</td>
          <td class="paramname"><em>multi</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Generate an auth token based on username and timestamp. </p>
<p>The idea of auth token is to be stateless, so that we can verify use it even after we have forgotten about it or server has been restarted.</p>
<p>To achieve this even though we cannot trust the client we use HMAC to be able to verify the information.</p>
<p>Format of the auth-token (before base64 encode)</p>
<p>session id(12 bytes)|uint64 timestamp (8 bytes)| uint64 timestamp (8 bytes)|sha256-hmac(32 bytes)</p>
<p>The first timestamp is the time the token was initially created and is used to determine the maximum renewable time of the token. We always include this even if tokens do not expire (this value is not used) to keep the code cleaner.</p>
<p>The second timestamp is the time the token was renewed/regenerated and is used to determine if this token has been renewed in the acceptable time range (2 * renogiation timeout)</p>
<p>The session id is a random string of 12 byte (or 16 in base64) that is not used by OpenVPN itself but kept intact so that external logging/managment can track the session multiple reconnects/servers. It is delibrately chosen be a multiple of 3 bytes to have a base64 encoding without padding.</p>
<p>The hmac is calculated over the username contactinated with the raw auth-token bytes to include authentication of the username in the token</p>
<p>We encode the auth-token with base64 and then prepend "SESS_ID_" before sending it to the client.</p>
<p>This function will free() an existing multi-&gt;auth_token and keep the existing initial timestamp and session id contained in that token. </p>

<p class="definition">Definition at line <a class="el" href="auth__token_8c_source.html#l00176">176</a> of file <a class="el" href="auth__token_8c_source.html">auth_token.c</a>.</p>

<p class="reference">References <a class="el" href="buffer_8c_source.html#l00090">alloc_buf_gc()</a>, <a class="el" href="openvpn_2error_8h_source.html#l00218">ASSERT</a>, <a class="el" href="ssl__common_8h_source.html#l00567">tls_multi::auth_token</a>, <a class="el" href="ssl__common_8h_source.html#l00326">tls_options::auth_token_key</a>, <a class="el" href="auth__token_8c_source.html#l00023">AUTH_TOKEN_SESSION_ID_LEN</a>, <a class="el" href="ssl__common_8h_source.html#l00170">key_state::auth_token_state_flags</a>, <a class="el" href="ssl__common_8h_source.html#l00579">AUTH_TOKEN_VALID_EMPTYUSER</a>, <a class="el" href="buffer_8h_source.html#l00127">BLEN</a>, <a class="el" href="buffer_8h_source.html#l00124">BPTR</a>, <a class="el" href="buffer_8h_source.html#l00673">buf_write()</a>, <a class="el" href="buffer_8h_source.html#l00697">buf_write_u8()</a>, <a class="el" href="errlevel_8h_source.html#l00119">D_SHOW_KEYS</a>, <a class="el" href="openvpn_2error_8h_source.html#l00171">dmsg</a>, <a class="el" href="buffer_8h_source.html#l01032">gc_free()</a>, <a class="el" href="buffer_8h_source.html#l01024">gc_new()</a>, <a class="el" href="crypto_8h_source.html#l00167">key_ctx::hmac</a>, <a class="el" href="crypto__backend_8h.html#a253c2c692da0d3706ca0f2ac5628a90e">hmac_ctx_final()</a>, <a class="el" href="crypto__backend_8h.html#a11227ed744de3ec49ba41ebe20aecb7b">hmac_ctx_reset()</a>, <a class="el" href="crypto__backend_8h.html#a8625131329a13b2097ccacb82c83b3fe">hmac_ctx_size()</a>, <a class="el" href="crypto__backend_8h.html#a0a5053c34da29530f5ec4dd8a7ed8009">hmac_ctx_update()</a>, <a class="el" href="integer_8h_source.html#l00030">htonll</a>, <a class="el" href="ssl__common_8h_source.html#l00442">tls_session::key</a>, <a class="el" href="ssl__common_8h_source.html#l00381">KS_PRIMARY</a>, <a class="el" href="openvpn_2error_8h_source.html#l00091">M_FATAL</a>, <a class="el" href="openvpn_2error_8h_source.html#l00170">msg</a>, <a class="el" href="otime_8c_source.html#l00036">now</a>, <a class="el" href="src_2openvpn_2base64_8c_source.html#l00160">openvpn_base64_decode()</a>, <a class="el" href="src_2openvpn_2base64_8c_source.html#l00054">openvpn_base64_encode()</a>, <a class="el" href="ssl__common_8h_source.html#l00516">tls_multi::opt</a>, <a class="el" href="crypto__openssl_8c_source.html#l00532">rand_bytes()</a>, <a class="el" href="ssl__common_8h_source.html#l00597">tls_multi::session</a>, <a class="el" href="auth__token_8h_source.html#l00115">SESSION_ID_PREFIX</a>, <a class="el" href="ssl__common_8h_source.html#l00462">TM_ACTIVE</a>, and <a class="el" href="misc_8h_source.html#l00078">user_pass::username</a>.</p>

<p class="reference">Referenced by <a class="el" href="auth__token_8c_source.html#l00052">add_session_token_env()</a>, <a class="el" href="test__auth__token_8c_source.html#l00133">auth_token_basic_test()</a>, <a class="el" href="test__auth__token_8c_source.html#l00144">auth_token_fail_invalid_key()</a>, <a class="el" href="test__auth__token_8c_source.html#l00272">auth_token_test_empty_user()</a>, <a class="el" href="test__auth__token_8c_source.html#l00241">auth_token_test_known_keys()</a>, <a class="el" href="test__auth__token_8c_source.html#l00338">auth_token_test_random_keys()</a>, <a class="el" href="test__auth__token_8c_source.html#l00171">auth_token_test_timeout()</a>, and <a class="el" href="ssl__verify_8c_source.html#l01279">verify_user_pass()</a>.</p>

</div>
</div>
<a id="a8d927575260ef846146a4219a59384ab"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8d927575260ef846146a4219a59384ab">&#9670;&nbsp;</a></span>verify_auth_token()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">unsigned int verify_auth_token </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structuser__pass.html">user_pass</a> *&#160;</td>
          <td class="paramname"><em>up</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structtls__multi.html">tls_multi</a> *&#160;</td>
          <td class="paramname"><em>multi</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structtls__session.html">tls_session</a> *&#160;</td>
          <td class="paramname"><em>session</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Verifies the auth token to be in the format that generate_auth_token create and checks if the token is valid. </p>

<p class="definition">Definition at line <a class="el" href="auth__token_8c_source.html#l00302">302</a> of file <a class="el" href="auth__token_8c_source.html">auth_token.c</a>.</p>

<p class="reference">References <a class="el" href="ssl__verify_8c_source.html#l00817">auth_set_client_reason()</a>, <a class="el" href="ssl__common_8h_source.html#l00577">AUTH_TOKEN_EXPIRED</a>, <a class="el" href="ssl__common_8h_source.html#l00575">AUTH_TOKEN_HMAC_OK</a>, <a class="el" href="ssl__common_8h_source.html#l00571">tls_multi::auth_token_initial</a>, <a class="el" href="ssl__common_8h_source.html#l00326">tls_options::auth_token_key</a>, <a class="el" href="ssl__common_8h_source.html#l00324">tls_options::auth_token_lifetime</a>, <a class="el" href="auth__token_8c_source.html#l00023">AUTH_TOKEN_SESSION_ID_LEN</a>, <a class="el" href="ssl__common_8h_source.html#l00579">AUTH_TOKEN_VALID_EMPTYUSER</a>, <a class="el" href="auth__token_8c_source.html#l00286">check_hmac_token()</a>, <a class="el" href="crypto_8h_source.html#l00167">key_ctx::hmac</a>, <a class="el" href="errlevel_8h_source.html#l00055">M_INFO</a>, <a class="el" href="openvpn_2error_8h_source.html#l00093">M_WARN</a>, <a class="el" href="crypto__openssl_8c_source.html#l01167">memcmp_constant_time()</a>, <a class="el" href="openvpn_2error_8h_source.html#l00170">msg</a>, <a class="el" href="otime_8c_source.html#l00036">now</a>, <a class="el" href="integer_8h_source.html#l00035">ntohll</a>, <a class="el" href="src_2openvpn_2base64_8c_source.html#l00160">openvpn_base64_decode()</a>, <a class="el" href="ssl__common_8h_source.html#l00516">tls_multi::opt</a>, <a class="el" href="misc_8h_source.html#l00079">user_pass::password</a>, <a class="el" href="auth__token_8h_source.html#l00115">SESSION_ID_PREFIX</a>, <a class="el" href="auth__token_8c_source.html#l00029">TOKEN_DATA_LEN</a>, <a class="el" href="misc_8h_source.html#l00075">USER_PASS_LEN</a>, and <a class="el" href="misc_8h_source.html#l00078">user_pass::username</a>.</p>

<p class="reference">Referenced by <a class="el" href="test__auth__token_8c_source.html#l00133">auth_token_basic_test()</a>, <a class="el" href="test__auth__token_8c_source.html#l00144">auth_token_fail_invalid_key()</a>, <a class="el" href="test__auth__token_8c_source.html#l00272">auth_token_test_empty_user()</a>, <a class="el" href="test__auth__token_8c_source.html#l00362">auth_token_test_key_load()</a>, <a class="el" href="test__auth__token_8c_source.html#l00241">auth_token_test_known_keys()</a>, <a class="el" href="test__auth__token_8c_source.html#l00338">auth_token_test_random_keys()</a>, <a class="el" href="test__auth__token_8c_source.html#l00171">auth_token_test_timeout()</a>, and <a class="el" href="ssl__verify_8c_source.html#l01279">verify_user_pass()</a>.</p>

</div>
</div>
<a id="ae2422a1db17af810579e69329ed68b7f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae2422a1db17af810579e69329ed68b7f">&#9670;&nbsp;</a></span>wipe_auth_token()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void wipe_auth_token </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structtls__multi.html">tls_multi</a> *&#160;</td>
          <td class="paramname"><em>multi</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Wipes the authentication token out of the memory, frees and cleans up related buffers and flags. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">multi</td><td>Pointer to a multi object holding the auth_token variables </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="auth__token_8c_source.html#l00395">395</a> of file <a class="el" href="auth__token_8c_source.html">auth_token.c</a>.</p>

<p class="reference">References <a class="el" href="ssl__common_8h_source.html#l00567">tls_multi::auth_token</a>, <a class="el" href="ssl__common_8h_source.html#l00571">tls_multi::auth_token_initial</a>, and <a class="el" href="buffer_8h_source.html#l00401">secure_memzero()</a>.</p>

<p class="reference">Referenced by <a class="el" href="test__auth__token_8c_source.html#l00119">teardown()</a>, <a class="el" href="ssl__verify_8c_source.html#l00072">tls_deauthenticate()</a>, <a class="el" href="ssl_8c_source.html#l01348">tls_multi_free()</a>, <a class="el" href="ssl__verify_8c_source.html#l01453">verify_final_auth_checks()</a>, and <a class="el" href="ssl__verify_8c_source.html#l01279">verify_user_pass()</a>.</p>

</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="a9eadc45b0a43398b27fee777f6a6261d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9eadc45b0a43398b27fee777f6a6261d">&#9670;&nbsp;</a></span>auth_token_pem_name</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">const char* auth_token_pem_name = &quot;OpenVPN auth-token server <a class="el" href="structkey.html">key</a>&quot;</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="auth__token_8c_source.html#l00021">21</a> of file <a class="el" href="auth__token_8c_source.html">auth_token.c</a>.</p>

<p class="reference">Referenced by <a class="el" href="auth__token_8c_source.html#l00139">auth_token_init_secret()</a>, and <a class="el" href="auth__token_8c_source.html#l00133">auth_token_write_server_key_file()</a>.</p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
