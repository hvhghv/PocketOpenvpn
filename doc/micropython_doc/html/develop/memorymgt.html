<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Memory Management &#8212; MicroPython latest documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/classic.css?v=def86cc0" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=d5a28fe3" />
    <link rel="stylesheet" href="../_static/customstyle.css" type="text/css" />
    
    <script src="../_static/jquery.js?v=5d32c60e"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../_static/documentation_options.js?v=c6e86fd7"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Implementing a Module" href="library.html" />
    <link rel="prev" title="The Compiler" href="compiler.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="library.html" title="Implementing a Module"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="compiler.html" title="The Compiler"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">MicroPython latest documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">MicroPython Internals</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Memory Management</a></li> 
      </ul>
    </div>  

    <div class="document">
  
    <div class="wy-alert wy-alert-danger">
      <p>
        This is the documentation for the latest development branch of
        MicroPython and may refer to features that are not available in released
        versions.
      </p>
      <p>
        If you are looking for the documentation for a specific release, use
        the drop-down menu on the left and select the desired version.
      </p>
    </div>
  
  
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="memory-management">
<span id="memorymanagement"></span><h1>Memory Management<a class="headerlink" href="#memory-management" title="Link to this heading">¶</a></h1>
<p>Unlike programming languages such as C/C++, MicroPython hides memory management
details from the developer by supporting automatic memory management.
Automatic memory management is a technique used by operating systems or applications to automatically manage
the allocation and deallocation of memory. This eliminates challenges such as forgetting to
free the memory allocated to an object. Automatic memory management also avoids the critical issue of using memory
that is already released. Automatic memory management takes many forms, one of them being
garbage collection (GC).</p>
<p>The garbage collector usually has two responsibilities;</p>
<ol class="arabic simple">
<li><p>Allocate new objects in available memory.</p></li>
<li><p>Free unused memory.</p></li>
</ol>
<p>There are many GC algorithms but MicroPython uses the
<a class="reference external" href="https://en.wikipedia.org/wiki/Tracing_garbage_collection#Basic_algorithm">Mark and Sweep</a>
policy for managing memory. This algorithm has a mark phase that traverses the heap marking all
live objects while the sweep phase goes through the heap reclaiming all unmarked objects.</p>
<p>Garbage collection functionality in MicroPython is available through the <code class="docutils literal notranslate"><span class="pre">gc</span></code> built-in
module:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt;<span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span>
&gt;&gt;&gt;<span class="w"> </span>x
<span class="m">5</span>
&gt;&gt;&gt;<span class="w"> </span>import<span class="w"> </span>gc
&gt;&gt;&gt;<span class="w"> </span>gc.enable<span class="o">()</span>
&gt;&gt;&gt;<span class="w"> </span>gc.mem_alloc<span class="o">()</span>
<span class="m">1312</span>
&gt;&gt;&gt;<span class="w"> </span>gc.mem_free<span class="o">()</span>
<span class="m">2071392</span>
&gt;&gt;&gt;<span class="w"> </span>gc.collect<span class="o">()</span>
<span class="m">19</span>
&gt;&gt;&gt;<span class="w"> </span>gc.disable<span class="o">()</span>
&gt;&gt;&gt;
</pre></div>
</div>
<p>Even when <code class="docutils literal notranslate"><span class="pre">gc.disable()</span></code> is invoked, collection can be triggered with <code class="docutils literal notranslate"><span class="pre">gc.collect()</span></code>.</p>
<section id="the-object-model">
<h2>The object model<a class="headerlink" href="#the-object-model" title="Link to this heading">¶</a></h2>
<p>All MicroPython objects are referred to by the <code class="docutils literal notranslate"><span class="pre">mp_obj_t</span></code> data type.
This is usually word-sized (i.e. the same size as a pointer on the target architecture),
and can be typically 32-bit (STM32, nRF, ESP32, Unix x86) or 64-bit (Unix x64).
It can also be greater than a word-size for certain object representations, for
example <code class="docutils literal notranslate"><span class="pre">OBJ_REPR_D</span></code> has a 64-bit sized <code class="docutils literal notranslate"><span class="pre">mp_obj_t</span></code> on a 32-bit architecture.</p>
<p>An <code class="docutils literal notranslate"><span class="pre">mp_obj_t</span></code> represents a MicroPython object, for example an integer, float, type, dict or
class instance. Some objects, like booleans and small integers, have their value stored directly
in the <code class="docutils literal notranslate"><span class="pre">mp_obj_t</span></code> value and do not require additional memory. Other objects have their value
store elsewhere in memory (for example on the garbage-collected heap) and their <code class="docutils literal notranslate"><span class="pre">mp_obj_t</span></code> contains
a pointer to that memory. A portion of <code class="docutils literal notranslate"><span class="pre">mp_obj_t</span></code> is the tag which tells what type of object it is.</p>
<p>See <code class="docutils literal notranslate"><span class="pre">py/mpconfig.h</span></code> for the specific details of the available representations.</p>
<p><strong>Pointer tagging</strong></p>
<p>Because pointers are word-aligned, when they are stored in an <code class="docutils literal notranslate"><span class="pre">mp_obj_t</span></code> the
lower bits of this object handle will be zero.  For example on a 32-bit architecture
the lower 2 bits will be zero:</p>
<p><code class="docutils literal notranslate"><span class="pre">********|********|********|******00</span></code></p>
<p>These bits are reserved for purposes of storing a tag. The tag stores extra information as
opposed to introducing a new field to store that information in the object, which may be
inefficient.  In MicroPython the tag tells if we are dealing with a small integer, interned
(small) string or a concrete object, and different semantics apply to each of these.</p>
<p>For small integers the mapping is this:</p>
<p><code class="docutils literal notranslate"><span class="pre">********|********|********|*******1</span></code></p>
<p>Where the asterisks hold the actual integer value.  For an interned string or an immediate
object (e.g. <code class="docutils literal notranslate"><span class="pre">True</span></code>) the layout of the <code class="docutils literal notranslate"><span class="pre">mp_obj_t</span></code> value is, respectively:</p>
<p><code class="docutils literal notranslate"><span class="pre">********|********|********|*****010</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">********|********|********|*****110</span></code></p>
<p>While a concrete object that is none of the above takes the form:</p>
<p><code class="docutils literal notranslate"><span class="pre">********|********|********|******00</span></code></p>
<p>The stars here correspond to the address of the concrete object in memory.</p>
</section>
<section id="allocation-of-objects">
<h2>Allocation of objects<a class="headerlink" href="#allocation-of-objects" title="Link to this heading">¶</a></h2>
<p>The value of a small integer is stored directly in the <code class="docutils literal notranslate"><span class="pre">mp_obj_t</span></code> and will be
allocated in-place, not on the heap or elsewhere.  As such, creation of small
integers does not affect the heap.  Similarly for interned strings that already have
their textual data stored elsewhere, and immediate values like <code class="docutils literal notranslate"><span class="pre">None</span></code>, <code class="docutils literal notranslate"><span class="pre">False</span></code>
and <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p>
<p>Everything else which is a concrete object is allocated on the heap and its object structure is such that
a field is reserved in the object header to store the type of the object.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>+++++++++++
+<span class="w">         </span>+
+<span class="w"> </span><span class="nb">type</span><span class="w">    </span>+<span class="w"> </span>object<span class="w"> </span>header
+<span class="w">         </span>+
+++++++++++
+<span class="w">         </span>+<span class="w"> </span>object<span class="w"> </span>items
+<span class="w">         </span>+
+<span class="w">         </span>+
+++++++++++
</pre></div>
</div>
<p>The heap’s smallest unit of allocation is a block, which is four machine words in
size (16 bytes on a 32-bit machine, 32 bytes on a 64-bit machine).
Another structure also allocated on the heap tracks the allocation of
objects in each block. This structure is called a <em>bitmap</em>.</p>
<img alt="../_images/bitmap.png" src="../_images/bitmap.png" />
<p>The bitmap tracks whether a block is “free” or “in use” and use two bits to track this state
for each block.</p>
<p>The mark-sweep garbage collector manages the objects allocated on the heap, and also
utilises the bitmap to mark objects that are still in use.
See <a class="reference external" href="https://github.com/micropython/micropython/blob/master/py/gc.c">py/gc.c</a>
for the full implementation of these details.</p>
<p><strong>Allocation: heap layout</strong></p>
<p>The heap is arranged such that it consists of blocks in pools. A block
can have different properties:</p>
<ul class="simple">
<li><p><em>ATB(allocation table byte):</em> If set, then the block is a normal block</p></li>
<li><p><em>FREE:</em> Free block</p></li>
<li><p><em>HEAD:</em> Head of a chain of blocks</p></li>
<li><p><em>TAIL:</em> In the tail of a chain of blocks</p></li>
<li><p><em>MARK :</em> Marked head block</p></li>
<li><p><em>FTB(finaliser table byte):</em> If set, then the block has a finaliser</p></li>
</ul>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>

      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Memory Management</a><ul>
<li><a class="reference internal" href="#the-object-model">The object model</a></li>
<li><a class="reference internal" href="#allocation-of-objects">Allocation of objects</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="compiler.html"
                          title="previous chapter">The Compiler</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="library.html"
                          title="next chapter">Implementing a Module</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/develop/memorymgt.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="library.html" title="Implementing a Module"
             >next</a> |</li>
        <li class="right" >
          <a href="compiler.html" title="The Compiler"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">MicroPython latest documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >MicroPython Internals</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Memory Management</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright - The MicroPython Documentation is Copyright © 2014-2024, Damien P. George, Paul Sokolovsky, and contributors.
      Last updated on 24 Jul 2024.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.4.7.
    </div>
  </body>
</html>