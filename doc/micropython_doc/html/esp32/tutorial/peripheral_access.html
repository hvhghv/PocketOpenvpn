<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>3. Accessing peripherals directly via registers &#8212; MicroPython latest documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/classic.css?v=def86cc0" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=d5a28fe3" />
    <link rel="stylesheet" href="../../_static/customstyle.css" type="text/css" />
    
    <script src="../../_static/jquery.js?v=5d32c60e"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../../_static/documentation_options.js?v=c6e86fd7"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Quick reference for the RP2" href="../../rp2/quickref.html" />
    <link rel="prev" title="2. Pulse Width Modulation" href="pwm.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../../rp2/quickref.html" title="Quick reference for the RP2"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="pwm.html" title="2. Pulse Width Modulation"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">MicroPython latest documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../quickref.html" >Quick reference for the ESP32</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">MicroPython tutorial for ESP32</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">3. </span>Accessing peripherals directly via registers</a></li> 
      </ul>
    </div>  

    <div class="document">
  
    <div class="wy-alert wy-alert-danger">
      <p>
        This is the documentation for the latest development branch of
        MicroPython and may refer to features that are not available in released
        versions.
      </p>
      <p>
        If you are looking for the documentation for a specific release, use
        the drop-down menu on the left and select the desired version.
      </p>
    </div>
  
  
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="accessing-peripherals-directly-via-registers">
<h1><span class="section-number">3. </span>Accessing peripherals directly via registers<a class="headerlink" href="#accessing-peripherals-directly-via-registers" title="Link to this heading">¶</a></h1>
<p>The ESP32’s peripherals can be controlled via direct register reads and writes.
This requires reading the datasheet to know what registers to use and what
values to write to them.  The following example shows how to turn on and change
the prescaler of the MCPWM0 peripheral.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">micropython</span> <span class="kn">import</span> <span class="n">const</span>
<span class="kn">from</span> <span class="nn">machine</span> <span class="kn">import</span> <span class="n">mem32</span>

<span class="c1"># Define the register addresses that will be used.</span>
<span class="n">DR_REG_DPORT_BASE</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mh">0x3FF00000</span><span class="p">)</span>
<span class="n">DPORT_PERIP_CLK_EN_REG</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="n">DR_REG_DPORT_BASE</span> <span class="o">+</span> <span class="mh">0x0C0</span><span class="p">)</span>
<span class="n">DPORT_PERIP_RST_EN_REG</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="n">DR_REG_DPORT_BASE</span> <span class="o">+</span> <span class="mh">0x0C4</span><span class="p">)</span>
<span class="n">DPORT_PWM0_CLK_EN</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">)</span>
<span class="n">MCPWM0</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mh">0x3FF5E000</span><span class="p">)</span>
<span class="n">MCPWM1</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mh">0x3FF6C000</span><span class="p">)</span>

<span class="c1"># Enable CLK and disable RST.</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">mem32</span><span class="p">[</span><span class="n">DPORT_PERIP_CLK_EN_REG</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">mem32</span><span class="p">[</span><span class="n">DPORT_PERIP_RST_EN_REG</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">))</span>
<span class="n">mem32</span><span class="p">[</span><span class="n">DPORT_PERIP_CLK_EN_REG</span><span class="p">]</span> <span class="o">|=</span> <span class="n">DPORT_PWM0_CLK_EN</span>
<span class="n">mem32</span><span class="p">[</span><span class="n">DPORT_PERIP_RST_EN_REG</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DPORT_PWM0_CLK_EN</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">mem32</span><span class="p">[</span><span class="n">DPORT_PERIP_CLK_EN_REG</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">mem32</span><span class="p">[</span><span class="n">DPORT_PERIP_RST_EN_REG</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">))</span>

<span class="c1"># Change the MCPWM0 prescaler.</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">mem32</span><span class="p">[</span><span class="n">MCPWM0</span><span class="p">]))</span> <span class="c1"># read PWM_CLK_CFG_REG (reset value = 0)</span>
<span class="n">mem32</span><span class="p">[</span><span class="n">MCPWM0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x55</span>      <span class="c1"># change PWM_CLK_PRESCALE</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">mem32</span><span class="p">[</span><span class="n">MCPWM0</span><span class="p">]))</span> <span class="c1"># read PWM_CLK_CFG_REG</span>
</pre></div>
</div>
<p>Note that before a peripheral can be used its clock must be enabled and it must
be taken out of reset.  In the above example the following registers are used
for this:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">DPORT_PERI_CLK_EN_REG</span></code>: used to enable a peripheral clock</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DPORT_PERI_RST_EN_REG</span></code>: used to reset (or take out of reset) a peripheral</p></li>
</ul>
<p>The MCPWM0 peripheral is in bit position 17 of the above two registers, hence
the value of <code class="docutils literal notranslate"><span class="pre">DPORT_PWM0_CLK_EN</span></code>.</p>
<section id="synchronous-access-to-pins-directly-via-registers">
<h2><span class="section-number">3.1. </span>Synchronous access to pins directly via registers<a class="headerlink" href="#synchronous-access-to-pins-directly-via-registers" title="Link to this heading">¶</a></h2>
<p>The following code shows how to access pins directly via registers.  It has been
tested on a generic ESP32 board.  It configures pins 16, 17, 32 and 33 in output
mode via registers, and switches pin output values via registers.  Pins 16 and
17 are switched simultaneously.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">micropython</span> <span class="kn">import</span> <span class="n">const</span>
<span class="kn">from</span> <span class="nn">machine</span> <span class="kn">import</span> <span class="n">mem32</span><span class="p">,</span> <span class="n">Pin</span>

<span class="n">GPIO_OUT_REG</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mh">0x3FF44004</span><span class="p">)</span>  <span class="c1"># GPIO 0-31 output register</span>
<span class="n">GPIO_OUT1_REG</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mh">0x3FF44010</span><span class="p">)</span>  <span class="c1"># GPIO 32-39 output register</span>

<span class="n">GPIO_ENABLE_REG</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mh">0x3FF44020</span><span class="p">)</span>  <span class="c1"># GPIO 0-31 output enable register</span>
<span class="n">GPIO_ENABLE1_REG</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mh">0x3FF4402C</span><span class="p">)</span>  <span class="c1"># GPIO 32-39 output enable register</span>

<span class="n">M16</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span>  <span class="c1"># Pin(16) bit mask</span>
<span class="n">M17</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span>  <span class="c1"># Pin(17) bit mask</span>

<span class="n">M32</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">32</span><span class="o">-</span><span class="mi">32</span><span class="p">)</span>  <span class="c1"># Pin(32) bit mask</span>
<span class="n">M33</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">33</span><span class="o">-</span><span class="mi">32</span><span class="p">)</span>  <span class="c1"># Pin(33) bit mask</span>

<span class="c1"># Enable pin output mode like</span>
<span class="c1"># p16 = Pin(16, mode=Pin.OUT)</span>
<span class="c1"># p17 = Pin(17, mode=Pin.OUT)</span>
<span class="c1"># p32 = Pin(32, mode=Pin.OUT)</span>
<span class="c1"># p33 = Pin(33, mode=Pin.OUT)</span>
<span class="n">mem32</span><span class="p">[</span><span class="n">GPIO_ENABLE_REG</span><span class="p">]</span> <span class="o">=</span> <span class="n">mem32</span><span class="p">[</span><span class="n">GPIO_ENABLE_REG</span><span class="p">]</span> <span class="o">|</span> <span class="n">M16</span> <span class="o">|</span> <span class="n">M17</span>
<span class="n">mem32</span><span class="p">[</span><span class="n">GPIO_ENABLE1_REG</span><span class="p">]</span> <span class="o">=</span> <span class="n">mem32</span><span class="p">[</span><span class="n">GPIO_ENABLE1_REG</span><span class="p">]</span> <span class="o">|</span> <span class="n">M32</span> <span class="o">|</span> <span class="n">M33</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">mem32</span><span class="p">[</span><span class="n">GPIO_OUT_REG</span><span class="p">]),</span> <span class="nb">hex</span><span class="p">(</span><span class="n">mem32</span><span class="p">[</span><span class="n">GPIO_OUT1_REG</span><span class="p">]))</span>

<span class="c1"># Set outputs to 1 like</span>
<span class="c1"># p16(1)</span>
<span class="c1"># p17(1)</span>
<span class="c1"># p32(1)</span>
<span class="c1"># p33(1)</span>
<span class="n">mem32</span><span class="p">[</span><span class="n">GPIO_OUT_REG</span><span class="p">]</span> <span class="o">=</span> <span class="n">mem32</span><span class="p">[</span><span class="n">GPIO_OUT_REG</span><span class="p">]</span> <span class="o">|</span> <span class="n">M16</span> <span class="o">|</span> <span class="n">M17</span>
<span class="n">mem32</span><span class="p">[</span><span class="n">GPIO_OUT1_REG</span><span class="p">]</span> <span class="o">=</span> <span class="n">mem32</span><span class="p">[</span><span class="n">GPIO_OUT1_REG</span><span class="p">]</span> <span class="o">|</span> <span class="n">M32</span> <span class="o">|</span> <span class="n">M33</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">mem32</span><span class="p">[</span><span class="n">GPIO_OUT_REG</span><span class="p">]),</span> <span class="nb">hex</span><span class="p">(</span><span class="n">mem32</span><span class="p">[</span><span class="n">GPIO_OUT1_REG</span><span class="p">]))</span>

<span class="c1"># Set outputs to 0 like</span>
<span class="c1"># p16(0)</span>
<span class="c1"># p17(0)</span>
<span class="c1"># p32(0)</span>
<span class="c1"># p33(0)</span>
<span class="n">mem32</span><span class="p">[</span><span class="n">GPIO_OUT_REG</span><span class="p">]</span> <span class="o">=</span> <span class="n">mem32</span><span class="p">[</span><span class="n">GPIO_OUT_REG</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">M16</span> <span class="o">|</span> <span class="n">M17</span><span class="p">)</span>
<span class="n">mem32</span><span class="p">[</span><span class="n">GPIO_OUT1_REG</span><span class="p">]</span> <span class="o">=</span> <span class="n">mem32</span><span class="p">[</span><span class="n">GPIO_OUT1_REG</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">M32</span> <span class="o">|</span> <span class="n">M33</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">mem32</span><span class="p">[</span><span class="n">GPIO_OUT_REG</span><span class="p">]),</span> <span class="nb">hex</span><span class="p">(</span><span class="n">mem32</span><span class="p">[</span><span class="n">GPIO_OUT1_REG</span><span class="p">]))</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="c1"># Set outputs to 1</span>
    <span class="n">mem32</span><span class="p">[</span><span class="n">GPIO_OUT_REG</span><span class="p">]</span> <span class="o">=</span> <span class="n">mem32</span><span class="p">[</span><span class="n">GPIO_OUT_REG</span><span class="p">]</span> <span class="o">|</span> <span class="n">M16</span> <span class="o">|</span> <span class="n">M17</span>
    <span class="n">mem32</span><span class="p">[</span><span class="n">GPIO_OUT1_REG</span><span class="p">]</span> <span class="o">=</span> <span class="n">mem32</span><span class="p">[</span><span class="n">GPIO_OUT1_REG</span><span class="p">]</span> <span class="o">|</span> <span class="n">M32</span> <span class="o">|</span> <span class="n">M33</span>

    <span class="c1"># Set outputs to 0</span>
    <span class="n">mem32</span><span class="p">[</span><span class="n">GPIO_OUT_REG</span><span class="p">]</span> <span class="o">=</span> <span class="n">mem32</span><span class="p">[</span><span class="n">GPIO_OUT_REG</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">M16</span> <span class="o">|</span> <span class="n">M17</span><span class="p">)</span>
    <span class="n">mem32</span><span class="p">[</span><span class="n">GPIO_OUT1_REG</span><span class="p">]</span> <span class="o">=</span> <span class="n">mem32</span><span class="p">[</span><span class="n">GPIO_OUT1_REG</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">M32</span> <span class="o">|</span> <span class="n">M33</span><span class="p">)</span>
</pre></div>
</div>
<p>Output is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mh">0x0</span> <span class="mh">0x0</span>
<span class="mh">0x30000</span> <span class="mh">0x3</span>
<span class="mh">0x0</span> <span class="mh">0x0</span>
</pre></div>
</div>
<p>Pins 16 and 17 are switched synchronously:</p>
<img alt="../../_images/mem32_gpio_output.jpg" src="../../_images/mem32_gpio_output.jpg" />
<p>Same image on pins 32 and 33.</p>
<p>Note that pins 34-36 and 39 are inputs only. Also pins 1 and 3 are Tx, Rx of the REPL UART,
pins 6-11 are connected to the built-in SPI flash.</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>

      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">3. Accessing peripherals directly via registers</a><ul>
<li><a class="reference internal" href="#synchronous-access-to-pins-directly-via-registers">3.1. Synchronous access to pins directly via registers</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="pwm.html"
                          title="previous chapter"><span class="section-number">2. </span>Pulse Width Modulation</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="../../rp2/quickref.html"
                          title="next chapter">Quick reference for the RP2</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/esp32/tutorial/peripheral_access.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../../rp2/quickref.html" title="Quick reference for the RP2"
             >next</a> |</li>
        <li class="right" >
          <a href="pwm.html" title="2. Pulse Width Modulation"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">MicroPython latest documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../quickref.html" >Quick reference for the ESP32</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >MicroPython tutorial for ESP32</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">3. </span>Accessing peripherals directly via registers</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright - The MicroPython Documentation is Copyright © 2014-2024, Damien P. George, Paul Sokolovsky, and contributors.
      Last updated on 24 Jul 2024.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.4.7.
    </div>
  </body>
</html>